---
name: run-tests

on:
  workflow_dispatch:

permissions: read-all

env:
  SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}
  MISE_SOPS_AGE_KEY: ${{ secrets.SOPS_AGE_KEY }}

jobs:
  docker-mise-linux:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm, macos-15]
    timeout-minutes: 30
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run mise
        run: |
          docker run --rm -it \
            --env SOPS_AGE_KEY --env MISE_SOPS_AGE_KEY \
            -v "$PWD:/mnt" \
            -v "/var/run/docker.sock:/var/run/docker.sock" \
            --workdir /mnt \
            bash bash -c 'set -euxo pipefail && \
              apk add docker && \
              wget https://mise.run -O - | sh && \
              eval "$(~/.local/bin/mise activate bash)" && \
              mise run "create:*:*" && \
              mise run "delete:*:*" \
            '

  mise-linux:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm, macos-15]
    timeout-minutes: 30
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run mise
        run: |
          wget https://mise.run -O - | sh
          eval "$(~/.local/bin/mise activate bash)"
          mise run "create:*:*"
          mise run "delete:*:*"

  mise-windows:
    runs-on: windows-2025
    timeout-minutes: 30
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Run mise
        run: |
          scoop install mise
          mise run "create:*:*"
          mise run "delete:*:*"
