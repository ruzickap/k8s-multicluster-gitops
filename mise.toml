[tools]
# keep-sorted start
k3d = "5.8.3"
kind = "0.27.0"
sops = "3.9.4"
# keep-sorted end

[settings]
experimental = true
# Use MISE_SOPS_AGE_KEY="$(grep -v ^# ~/Documents/secrets/age.txt)" instead
# sops.age_key_file = "~/Documents/secrets/age.txt"
trusted_config_paths = ["/"]

[env]
_.file = ".env.yaml"
# Directory which contains the clusters mise configurations
CLUSTERS_DIRECTORY = "{{ config_root }}/clusters"
# Directory which contains the kubeconfig files for the created clusters (will be create if not exists)
CLUSTERS_KUBECONFIG_DIRECTORY = "{{ config_root }}/clusters/.kubeconfig"
# Directory which contains the scripts to create and delete the clusters
CLUSTERS_RUN_SCRIPT_DIRECTORY = "{{ config_root }}/scripts"

#######################################
# Kind
#######################################

[tasks."create:kind:kind01-internal"]
description = 'Create kind01.internal K8s cluster'
# Run mise again due to missing support for SOPS-encrypted environment variables in tasks: https://github.com/jdx/mise/discussions/4593
run = 'cd "${CLUSTERS_DIRECTORY}/${MISE_TASK_NAME##*:}" && mise run create:kind01-internal'

[tasks."delete:kind:kind01-internal"]
description = 'Delete kind01.internal K8s cluster'
run = 'cd "${CLUSTERS_DIRECTORY}/${MISE_TASK_NAME##*:}" && mise run delete:kind01-internal'

[tasks."create:kind:kind02-internal"]
description = 'Create kind02.internal K8s cluster'
run = 'cd "${CLUSTERS_DIRECTORY}/${MISE_TASK_NAME##*:}" && mise run create:kind02-internal'

[tasks."delete:kind:kind02-internal"]
description = 'Delete kind02.internal K8s cluster'
run = 'cd "${CLUSTERS_DIRECTORY}/${MISE_TASK_NAME##*:}" && mise run delete:kind02-internal'

#######################################
# K3d
#######################################

[tasks."create:k3d:k3d01-internal"]
description = 'Create k3d01.internal K8s cluster'
# Run mise again due to missing support for SOPS-encrypted environment variables in tasks: https://github.com/jdx/mise/discussions/4593
run = 'cd "${CLUSTERS_DIRECTORY}/${MISE_TASK_NAME##*:}" && mise run create:k3d01-internal'

[tasks."delete:k3d:k3d01-internal"]
description = 'Delete k3d01.internal K8s cluster'
run = 'cd "${CLUSTERS_DIRECTORY}/${MISE_TASK_NAME##*:}" && mise run delete:k3d01-internal'

[tasks."create:k3d:k3d02-internal"]
description = 'Create k3d02.internal K8s cluster'
run = 'cd "${CLUSTERS_DIRECTORY}/${MISE_TASK_NAME##*:}" && mise run create:k3d02-internal'

[tasks."delete:k3d:k3d02-internal"]
description = 'Delete k3d02.internal K8s cluster'
run = 'cd "${CLUSTERS_DIRECTORY}/${MISE_TASK_NAME##*:}" && mise run delete:k3d02-internal'
